<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Conversor Excel a VCF</title>
  <link rel="stylesheet" href="/styles.css">
  <script>
    async function fetchFiles() {
      const res = await fetch('/api/files');
      const files = await res.json();
      const tbody = document.querySelector('#files-body');
      tbody.innerHTML = '';
      for (const f of files) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.name}</td>
          <td>${((f.size/1048576) >= 1 ? (f.size/1048576).toFixed(1) : (f.size/1048576).toFixed(2))} mb ${f.rows!=null?`· ${f.rows} filas`:''}</td>
          <td>
            <div class="row">
              <label>Hoja (idx): <input type="number" value="0" min="0" class="sheet" /></label>
              <label>Tel (col idx): <input type="number" value="1" min="0" class="phone" /></label>
              <label>Nombre (col idx): <input type="number" value="2" min="0" class="name" /></label>
              <label>Header: <select class="header"><option value="auto">auto</option><option value="true">sí</option><option value="false">no</option></select></label>
              <label>Prefijo país: <input type="text" placeholder="+34" class="dial" /></label>
            </div>
          </td>
          <td class="row">
            <button class="btn" onclick="removeFile('${f.name}')">Eliminar</button>
            <button class="btn primary" onclick="generate(this, '${f.name}')">Generar VCF</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    async function removeFile(name) {
      if (!confirm('¿Eliminar ' + name + '?')) return;
      const res = await fetch('/api/files/' + encodeURIComponent(name), { method: 'DELETE' });
      if (res.ok) fetchFiles();
      else alert('No se pudo eliminar');
    }

    async function generate(btn, name) {
      const tr = btn.closest('tr');
      const sheet = tr.querySelector('.sheet').value;
      const phone = tr.querySelector('.phone').value;
      const ncol = tr.querySelector('.name').value;
      const header = tr.querySelector('.header').value;
      const dial = tr.querySelector('.dial').value;
      btn.disabled = true; btn.textContent = 'Generando…';
      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            file: name,
            sheetIndex: Number(sheet),
            phoneCol: Number(phone),
            nameCol: Number(ncol),
            hasHeader: header === 'auto' ? undefined : (header === 'true'),
            dialCode: dial || undefined
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error');
        const a = document.createElement('a');
        a.href = data.file;
        a.download = '';
        a.click();
      } catch (e) {
        alert(e.message);
      } finally {
        btn.disabled = false; btn.textContent = 'Generar VCF';
      }
    }

    async function onUpload(e) {
      e.preventDefault();
      const f = document.querySelector('#file').files[0];
      if (!f) { alert('Selecciona un archivo'); return; }
      const fd = new FormData();
      fd.append('file', f);
      const res = await fetch('/api/upload', { method:'POST', body: fd });
      if (res.ok) {
        (document.querySelector('#file')).value = '';
        fetchFiles();
      } else {
        alert('No se pudo subir');
      }
    }

    // Drag & Drop
    function setupDragDrop() {
      const dz = document.getElementById('dropzone');
      const fileInput = document.getElementById('file');
      const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
      ['dragenter','dragover','dragleave','drop'].forEach(ev => dz.addEventListener(ev, prevent));
      ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, () => dz.classList.add('is-dragover')));
      ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, () => dz.classList.remove('is-dragover')));
      dz.addEventListener('click', () => fileInput.click());
      dz.addEventListener('drop', async (e) => {
        const files = e.dataTransfer.files;
        if (!files || !files.length) return;
        const fd = new FormData();
        fd.append('file', files[0]);
        dz.classList.add('is-uploading');
        try {
          const res = await fetch('/api/upload', { method:'POST', body: fd });
          if (!res.ok) throw new Error('Error al subir');
          fetchFiles();
          toast('Archivo subido');
        } catch (err) {
          alert(err.message);
        } finally {
          dz.classList.remove('is-uploading');
        }
      });
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      requestAnimationFrame(() => t.classList.add('show'));
      setTimeout(() => {
        t.classList.remove('show');
        setTimeout(() => t.remove(), 300);
      }, 2000);
    }

    window.addEventListener('DOMContentLoaded', () => { fetchFiles(); setupDragDrop(); });
  </script>
  </head>
  <body>
    <header>
      <h1>Conversor Excel a VCF</h1>
      <span class="muted">Sube .xlsx/.xls/.csv</span>
    </header>

    <section>
      <form onsubmit="onUpload(event)" class="upload-form">
        <input id="file" type="file" accept=".xlsx,.xls,.csv" />
        <button class="btn primary" type="submit">Subir</button>
      </form>
      <div id="dropzone" class="dropzone">
        <div class="dz-contents">
          <div class="dz-icon">⬆</div>
          <div>Arrastra y suelta tu Excel aquí</div>
          <div class="muted">o haz clic para seleccionar</div>
        </div>
      </div>
    </section>

    <section>
      <h3>Archivos subidos</h3>
      <table>
        <thead>
          <tr>
            <th>Archivo</th>
            <th>Tamaño · Filas</th>
            <th>Parámetros</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="files-body"></tbody>
      </table>
    </section>
  </body>
  </html>


